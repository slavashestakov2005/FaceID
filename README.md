Система «свой-чужой».  
[Презентация](https://docs.google.com/presentation/d/1TZBpWhKmof9FLp4XzRLFW6GwD1Fmsk-J/edit?usp=sharing&ouid=104378135732805691471&rtpof=true&sd=true) с предзащиты.  
[Календарный план](https://docs.google.com/spreadsheets/d/1N6Cu9KpMLCV-4HiQI2XPntv9Kqjaka5IoL8DQEBPFJ0/edit?usp=sharing).

## Техническое задание
1. Загрузили через страничку фото "свой", на выходе получили сетку обученную под распознание данного экземпляра фото
2. Перенесли обученную сетку на "свое железо" , без доступа в интернет, через web-камеру (желательно любую) система дает ответ свой\чужой в виде текста в локальный текстовый файл
3. При возможности подключения "своего железа" к интернету - текст отправляется в Телеграм-бот 
4. Скорость распознания на "стандартном" железе (видеокарта до 4gb, 2014-2017гг) до 1мс (будет круто)

## Структура проекта
### Recognition
Распознаёт изображение конкретного человеческого лица.  
#### Варианты библиотек
| № | Библиотека | Сокращенное название | Описание |
| ----- | ----- | ----- | ----- |
| 1. | face_recognition | fr | Переводит лица в вектора и сравнивает их. Скорость около одного кадра в секунду. |
| 2. | cv2 | cv | Тренирует LBPHFaceRecognizer. Работает быстро. |
| 3. | keras + tensorflow | fn | Учится долго, определяет медленно и плохо. Большой расход вычислительной мощности. |

### Server
Представляет собой сервер, на который загружаются обучающие фото и выгружаются данные.
### Telegram
Telegram-бот, отправляющий сообщения «свой» или «чужой».

## Оценка качества работы
### Формальная оценка
1. Взят открытый набор данных [отсюда](http://vis-www.cs.umass.edu/lfw/#download), его копия [здесь](https://drive.google.com/drive/folders/1CNlhu4Nc0SNAsVURhdqVsPXKjzJMYa8R?usp=sharing).
2. На каждом изображении учится модель; каждая модель проверяется на всех изображениях.
3. Подсчитывается общее число ошибок и их суммарный вес:
    + Истинно «свой» и истинно «чужой» — правильные предсказания.
    + Ложно «чужой» — не правильное предсказание, вес — 1.
    + Ложно «свой» — не правильное предсказание, вес — 10.
4. Результатом служат следующие метрики:
    + Ошибочность — <суммарный вес ошибок> / <количество тестов>.
    + Количество ложно «чужих».
    + Количество ложно «своих».
### Близнецовый тест
1. Для оценивания качества работы модели берутся близнецы (назовём их A и B) и я (C).
2. Из [этих видео](https://drive.google.com/drive/folders/1sgXQaNVnnItobKVXmAkRPKBQVhQ3R-xk?usp=sharing) извлекаются фотографии лиц.
3. Лица случайно делятся на тестовую (15%) и тренировочную (85%) части. Распределение [здесь](https://drive.google.com/drive/folders/1tC4sC-Vmhz2E7BP6ASIQ5FSO6Lp7j2ZQ?usp=sharing).
4. Для A, B и C обучаются отдельные модели (по тренировочным частям).
5. Каждая модель проверяется на своей тестовой части; разные люди проверяются на полном наборе фото.
### Количественный тест
1. Берутся два [видео](https://drive.google.com/drive/folders/1p4yn2vvOJpPCBL-UU3u4SDHaAgUyAgLh?usp=sharing)
одного человека (меня): [тренировочное](https://drive.google.com/file/d/1sJB-r349A0ZBAsDdthbuYak3jwbiPcss/view?usp=sharing)
и [тестовое](https://drive.google.com/file/d/1O3XVtHe30C05H9QIM54lEncqxTWeN3-P/view?usp=sharing).
2. Из видео извлекаются фото и генерируются случайные выборки разных размеров из тренировочного видео. Эти фото [здесь](https://drive.google.com/drive/folders/1ZRUeHLuM6G1OZ2b2jcMj740F85aboyKF?usp=sharing).
3. На каждой выборке тренировочных фото обучаются отдельные модели и тестируются на всех фото из тестового видео.

## Оценка качества работы OpenCV
### Близнецовый тест (`tests/cv-twins`)
1. Все результаты есть в папке `tests/cv-twins` (в формате модель - фото).
2. Если модели показывают изображение «свой», то «коэффициент доверия» ниже 40, причём у близнецов показатель ниже.
3. Близнецы определяются с «коэффициентом доверия» около 75.
4. Не близнецы дают «коэффициент доверия» около 90.
8. Значит порог для «свой-чужой» должен быть примерно 60-70.
### Количественный тест (`tests/cv-count`)
1. Полученные результаты в папке `tests/cv-count` (названием файла является число фото, на которых обучалась модель). Обобщения этих результатов в папке `tests/cv-count/results`.
3. Метрики (среднее арифметическое, медиана и диапазон «коэффициента доверия») практически перестают меняться после 200 фото.
4. После 250 фото распределение «коэффициента доверия» практически не меняется.
5. Среднее время обработки фото после 500 тренировочных фото растёт не принося пользы.
6. Итого:
    + Оптимальное количество тренировочных фото 200-250.
    + Можно установить «коэффициента доверия» по умолчанию равным 55 и проверять, что 65% из тестовых фото - подходят.
    + Можно установить «коэффициента доверия» по умолчанию равным 60 и проверять, что 80% из тестовых фото - подходят.
7. Заметим, что такой подбор параметров соотносится с предыдущим тестированием и будет давать верные предсказания.
### Формальная оценка (`tests/cv`)
1. Формальная оценка проводилась по описанию выше, все результаты в папке `tests/cv`.
2. Модель всегда хорошо (0.0) определяет фото, на котором обучена (видимо, переучивается).
3. «Коэффициент доверия» по умолчанию должен быть равным 50.
4. Тогда ошибочность будет 0.18, а это точность около 98.2%.
5. Для согласования с предыдущими тестами, нужно проверять, что 50% из тестовых фото - подходят.
6. Так «чужому» будет сложно притвориться «своих». Можно установить чуть более жесткую проверку, но тогда «своему» придётся изменять лицо не слишком сильно.

## Оценка качества работы FaceNet
### Формальная оценка (`tests/fn`)
1. Формальная оценка проводилась по описанию выше, все результаты в папке `tests/fn`.
2. Модель не даёт 0.0 на фото, по котором обучена, и, возможно, не переучивается.
3. «Коэффициент доверия» по умолчанию равный 0.52 вполне подходит.
4. Тогда ошибочность будет 0.11, а это точность около 98.9%.
5. Процент подходящих фотографий ещё нужно проверять.
### Близнецовый тест (`tests/fn-twins`)
1. Все результаты есть в папке `tests/fn-twins` (в формате модель - фото).
2. Если модели показывают изображение «свой», то «коэффициент доверия» (средний арифметический и медиана) в диапазоне 0.3 - 0.4. 
3. Близнецы определяются с «коэффициентами доверия» около 0.5 - 0.65.
4. Не близнецы дают «коэффициент доверия» около 0.44 - 0.74.
8. Значит порог для «свой-чужой» должен быть примерно 0.4, при 50-60% подходящих фото.
### Количественный тест (`tests/fn-count`)
1. Полученные результаты в папке `tests/fn-count` (названием файла является число фото, на которых обучалась модель). Обобщения этих результатов в папке `tests/fn-count/results`.
3. Метрики (среднее арифметическое, медиана и диапазон «коэффициента доверия») после 250 фото начинают меняться медленно и примерно линейно.
4. После 500 фото распределение «коэффициента доверия» успокаивается и становится линейным; после 750 фото он изменения замедляются.
5. Среднее время обработки практически постоянно, на 1000 есть неожиданное изменение на 7.5 ms.
6. Итого:
    + Оптимальное количество тренировочных фото около 750-ти.
    + Можно установить «коэффициента доверия» по умолчанию равным 0.52 и проверять, что 55% из тестовых фото - подходят.
    + Можно установить «коэффициента доверия» по умолчанию равным 0.45 и проверять, что 30% из тестовых фото - подходят.
7. Заметим, что такой подбор параметров плохо соотносится с предыдущими тестированиями и не понятно, что с этим можно сделать.

## Доработки
### Проверка на живого человека
Чтобы отличить живого человека от фотографии, была использована идея из [статьи](https://machinelearningmastery.ru/real-time-face-liveness-detection-with-python-keras-and-opencv-c35dc70dafd3/).
С кадров лиц извлекаются глаза, и определяется количество открытых глаз на фото.
Основная идея в том, что живой человек будет моргать, а фото - нет.
Копию обучающих и тестовых фото с открытыми и закрытыми глаза можно скачать [отсюда](https://drive.google.com/drive/folders/1vHDVJ8YTibj31oVs8VfZicGgPoMSFjc4?usp=sharing).

## Запуск
### Server
Файл `server.py` запускает сервер, получающий картинки и возвращающий распознаватель лиц.
### Client
Файл `client.py` запускает распознавание лиц по модели.
### Faceid
Файл `faceid.py` запускает игру с пользователем (пользователю нужно сделать вид, что он «чужой»). Сделано специально для
итогового мероприятия гимназии.

## Установка
+ Работает под `Python 3.11` (скорее всего и под `Python 3.8`, другие версии не проверялись), можно скачать [отсюда](https://www.python.org/downloads/).
+ Установить библиотеки согласно `requirements.txt`.

## Библиография
+ [Пример](https://habr.com/ru/company/netologyru/blog/434354/) с Face Recognition.
+ Ещё один [пример](https://pythonist.ru/raspoznavanie-licz-pri-pomoshhi-python-i-opencv/?ysclid=l2oyvdygyk).
+ [OpenCV и LBPHFaceRecognizer](https://robotos.in/uroki/obnaruzhenie-i-raspoznavanie-litsa-na-python).
+ Другой [пример](https://habr.com/ru/post/301096/).
+ [FaceNet](https://neurohive.io/ru/tutorial/raspoznavanie-lica-facenet/).
+ [Статья](https://habr.com/ru/company/ntechlab/blog/329412/) об оценке качества распознавания.

## Благодарности
Благодарю близнецов, принявших участие в тестировании системы. Имена не указываются без их согласия.
